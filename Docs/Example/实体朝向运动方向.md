
### 实体朝向运动方向

#### 资源包计算方案1

动画：

```
"animation.touhou_little_maid.danmaku.rot_by_param_amulet_auto": {
  "loop": true,
  "bones": {
    "rot_y": {
      "rotation": [
        0,
        "90 - query.target_y_rotation",
        0
      ]
    },
    "rot_zx": {
      "rotation": [
        "q.property('thlm:r_x')", // 由行为包决定，这个旋转与朝向无关
        0,
        "-query.target_x_rotation"
      ]
    }
  }
}
```

#### 资源包计算方案2

动画：

```
"animation.touhou_little_maid.danmaku.rot_by_param0": {
  "loop": true,
  "bones": {
    "rot_y": {
      "rotation": [
        0, 
        "math.atan2(v.dir_z, v.dir_x)", 
        0
      ]
    },
    "rot_zx": {
      "rotation": [
        "q.property('thlm:r_x')",
        0,
        "math.atan2(v.dir_y, math.sqrt(v.dir_x*v.dir_x + v.dir_z*v.dir_z))"
      ]
    }
  }
}
```

实体定义，实现了自动计算运动方向：

```
"animations": {
  "rotate": "animation.touhou_little_maid.danmaku.rot_by_param_amulet",
  "life": "animation.touhou_little_maid.danmaku.life",
  "scale": "animation.touhou_little_maid.danmaku.amulet_scale"
},
"scripts": {
  "pre_animation": [
    "v.temp_dir_x = q.position(0) - v.pos_x;",
    "v.temp_dir_y = q.position(1) - v.pos_y;",
    "v.temp_dir_z = q.position(2) - v.pos_z;",
    "v.is_moving = (v.temp_dir_x!=0)||(v.temp_dir_y!=0)||(v.temp_dir_z!=0);",
    "v.dir_x = v.is_moving ? -v.temp_dir_x : v.dir_x;",
    "v.dir_y = v.is_moving ? v.temp_dir_y : v.dir_y;",
    "v.dir_z = v.is_moving ? -v.temp_dir_z : v.dir_z;",

    "v.pos_x = q.position(0);",
    "v.pos_y = q.position(1);",
    "v.pos_z = q.position(2);"
  ],
  "animate": [
    "rotate",
    "life",
    "scale"
  ],
  "initialize": [
    "v.pos_x = q.position(0);",
    "v.pos_y = q.position(1);",
    "v.pos_z = q.position(2);",
    "v.dir_x = 0;",
    "v.dir_y = 0;",
    "v.dir_z = 0;",
    "v.temp_dir_x = 0;",
    "v.temp_dir_y = 0;",
    "v.temp_dir_z = 0;",
    "v.is_moving = 0;",
    "v.is_init = 0;"
  ]
},
```

模型，这个模型通过骨骼，把旋转顺序变为了 Y-Z-X：

```
{
	"format_version": "1.12.0",
	"minecraft:geometry": [
		{
			"description": {
				"identifier": "geometry.danmaku_bullet_amulet",
				"texture_width": 416,
				"texture_height": 32,
				"visible_bounds_width": 5,
				"visible_bounds_height": 5,
				"visible_bounds_offset": [0, 0.5, 0]
			},
			"bones": [
				{
					"name": "danmaku",
					"pivot": [0, 0, 0]
				},
				{
					"name": "rot_y",
					"parent": "danmaku",
					"pivot": [0, 0, 0]
				},
				{
					"name": "rot_zx",
					"parent": "rot_y",
					"pivot": [0, 0, 0],
					"cubes": [
						{
							"origin": [-7, -6, 0],
							"size": [14, 12, 0],
							"uv": {
								"north": {"uv": [10, 9], "uv_size": [12, 14]}
							}
						}
					]
				}
			]
		}
	]
}
```

缺点：
不够灵活，只能朝向运动方向，要做偏移会很麻烦

#### 脚本计算方案

模型同资源包计算方案

动画，需要事先在行为包定义三个旋转角度：

```
"animation.touhou_little_maid.danmaku.rot_by_param_amulet": {
  "loop": true,
  "bones": {
    "rot_y": {
      "rotation": [
        0,
        "90 - query.property('thlm:r_x')",
        0
      ]
    },
    "rot_zx": {
      "rotation": [
        "q.property('thlm:r_x')",
        0,
        "-q.property('thlm:r_z')"
      ]
    }
  }
}
```

脚本：

```
```